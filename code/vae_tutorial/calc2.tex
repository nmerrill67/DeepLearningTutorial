\documentclass[border=15pt, multi, tikz]{standalone}
\usepackage{import}
\usepackage{graphicx}% http://ctan.org/pkg/graphicx
\usepackage{amsmath, amsfonts}% http://ctan.org/pkg/amsmath
\subimport{thirdparty/layers/}{init}
\usetikzlibrary{positioning}
\usetikzlibrary{3d} %for including external image 

\def\ConvColor{rgb:blue, 5;green,10}
\def\ConvReluColor{rgb:blue,5;green,10}
\def\SoftmaxColor{rgb:red,1; yellow,10}
\def\SubpixColor{rgb:blue,5;green,2.5;white,5}
\def\PoolColor{rgb:magenta,5;black,7}
\def\SumColor{rgb:black,15;white,15}
\def\SliceColor{rgb:red,15}

\begin{document}
\begin{tikzpicture}
\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw Layer Blocks
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\node[canvas is zy plane at x=0] (temp) at (-3,0,0) {\includegraphics[width=8cm,height=8cm]{figs/orig.jpg}};
% block 1
\pic[shift={(0,0,0)}] at (0,0,0) {RightBandedBox={name=b1,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=40,width={4,3,4},depth=40}};
% block2
\pic[shift={(2,0,0)}] at (b1-east) {RightBandedBox={name=b2,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=40,width={3,4},depth=40}};
\pic[shift={(0,0,0)}] at (b2-east) {Box={name=p2,%
        fill=\PoolColor,opacity=0.5,height=30,width=1,depth=30}};
% conv3_1,conv3_2,pool3
\pic[shift={(2,0,0)}] at (p2-east) {RightBandedBox={name=cr3,%a
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=30,width={5,5},depth=30}};
\pic[shift={(0,0,0)}] at (cr3-east) {Box={name=p3,%
        fill=\PoolColor,opacity=0.5,height=23,width=1,depth=23}};
% conv4_1,conv4_2,conv4_3,pool4
\pic[shift={(1.8,0,0)}] at (p3-east) {RightBandedBox={name=cr4,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=20,width={7,7},depth=20}};
\pic[shift={(0,0,0)}] at (cr4-east) {Box={name=p4,%
        fill=\PoolColor,opacity=0.5,height=15,width=1,depth=15}};
% conv5_1,conv5_2,conv5_3,pool5
\pic[shift={(1.5,0,0)}] at (p4-east) {RightBandedBox={name=cr5,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=15,width={10,10},depth=15}};
\pic[shift={(0,0,0)}] at (cr5-east) {Box={name=p5,%
        fill=\PoolColor,opacity=0.5,height=10,width=1,depth=10}};    

\pic[shift={(1,0,0)}] at (p5-east) {RightBandedBox={name=cr6,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=10,width={12,12},depth=10}};  

\pic[shift={(4,-1,0)}] at (cr6-south) {Box={name=mu,caption=\scalebox{2}{$\boldsymbol{\mu}$},%
        fill=\ConvColor,%
        height=10,width=7,depth=10}};

\pic[shift={(4,1.5,0)}] at (cr6-north) {Box={name=sig,caption=\scalebox{2}{$\boldsymbol{\sigma}$},%
        fill=\ConvColor,%
        height=10,width=7,depth=10}};

\pic[shift={(2.5,2,0)}] at (mu-east) {Ball={name=sample,%
        fill=\SumColor,opacity=0.3,%
        radius=3.5,logo=\tiny{*/+}}};

\pic[shift={(1.8,-6,0)}] at (sig-east) {Box={name=eps,%
        caption=\scalebox{2}{$\boldsymbol{\epsilon} \sim \mathcal{N}(\mathbf{0},\ \mathbf{I})$},%
        fill=\ConvColor,%
        height=10,width=7,depth=10}};

\pic[shift={(1.5,0,0)}] at (sample-east) {Box={name=z,caption=\scalebox{2}{$\mathbf{z}$},%
        fill=\ConvColor,%
        height=10,width=7,depth=10}};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Joining with previous streams (fcn-16s)
%% Upsampling Subpixel Layer
\pic[shift={(2,10.5,0)}] at (z-east) {Box={name=z1,%
        fill=\SliceColor,%
        height=10,width={1},depth=10}};  

\pic[shift={(1.5,0,0)}] at (z1-east) {RightBandedBox={name=u11,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=10,width=7,depth=10}};

\pic[shift={(1.5,0,0)}] at (u11-east) {Box={name=s11,%
        fill=\SubpixColor, height=15,width=4,depth=15}};

\pic[shift={(0,0,0)}] at (s11-east) {RightBandedBox={name=u21,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=15,width={5,5},depth=15}};

\pic[shift={(1.5,0,0)}] at (u21-east) {Box={name=s21,%
        fill=\SubpixColor, height=20,width=3,depth=20}};

\pic[shift={(0,0,0)}] at (s21-east) {RightBandedBox={name=u31,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=20,width={4,4},depth=20}};

\pic[shift={(1.8,0,0)}] at (u31-east) {Box={name=s31,%
        fill=\SubpixColor, height=25,width=1,depth=25}};

\pic[shift={(0,0,0)}] at (s31-east) {RightBandedBox={name=u41,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=25,width={3,3,1},depth=25}};


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\node[shift={(0,-2.5,0)}] at (z1-south) {\scalebox{4}{\vdots}};
\node[shift={(0,-2.5,0)}] at (u11-south) {\scalebox{4}{\vdots}};
\node[shift={(-1,-2,0)}] at (u21-south) {\scalebox{4}{\vdots}};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pic[shift={(2,2.5,0)}] at (z-east) {Box={name=z2,%
        fill=\SliceColor,%
        height=10,width={1},depth=10}};  

\pic[shift={(1.5,0,0)}] at (z2-east) {RightBandedBox={name=u13,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=10,width=7,depth=10}};

\pic[shift={(1.5,0,0)}] at (u13-east) {Box={name=s13,%
        fill=\SubpixColor, height=15,width=4,depth=15}};

\pic[shift={(0,0,0)}] at (s13-east) {RightBandedBox={name=u23,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=15,width={5,5},depth=15}};

\pic[shift={(1.5,0,0)}] at (u23-east) {Box={name=s23,%
        fill=\SubpixColor, height=20,width=3,depth=20}};

\pic[shift={(0,0,0)}] at (s23-east) {RightBandedBox={name=u33,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=20,width={4,4},depth=20}};

\pic[shift={(1.8,0,0)}] at (u33-east) {Box={name=s33,%
        fill=\SubpixColor, height=25,width=1,depth=25}};

\pic[shift={(0,0,0)}] at (s33-east) {RightBandedBox={name=u43,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=25,width={3,3,1},depth=25}};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\pic[shift={(2,-5.5,0)}] at (z-east) {Box={name=z3,%
        fill=\SliceColor,%
        height=10,width={1},depth=10}};  

\pic[shift={(1.5,0,0)}] at (z3-east) {RightBandedBox={name=u12,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=10,width=7,depth=10}};

\pic[shift={(1.5,0,0)}] at (u12-east) {Box={name=s12,%
        fill=\SubpixColor, height=15,width=4,depth=15}};

\pic[shift={(0,0,0)}] at (s12-east) {RightBandedBox={name=u22,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=15,width={5,5},depth=15}};

\pic[shift={(1.5,0,0)}] at (u22-east) {Box={name=s22,%
        fill=\SubpixColor, height=20,width=3,depth=20}};

\pic[shift={(0,0,0)}] at (s22-east) {RightBandedBox={name=u32,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=20,width={4,4},depth=20}};

\pic[shift={(1.8,0,0)}] at (u32-east) {Box={name=s32,%
        fill=\SubpixColor, height=25,width=1,depth=25}};

\pic[shift={(0,0,0)}] at (s32-east) {RightBandedBox={name=u42,%
        fill=\ConvColor,bandfill=\ConvReluColor,%
        height=25,width={3,3,1},depth=25}};

\node[canvas is zy plane at x=1] (rec) at (u42-east) {\includegraphics[width=5cm,height=5cm]{figs/rec.jpg}};



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\node[shift={(2,-3,0)}] at (u41-east) (concat) {\scalebox{4}{$\mathbf \otimes$}};

\pic[shift={(1,0,0)}] at (concat.east) {Box={name=soft,%
        fill=\SoftmaxColor,%
        height=25,width={5},depth=25}};  

\node[canvas is zy plane at x=1] (seg) at (soft-east) {\includegraphics[width=5cm,height=5cm]{figs/seg.jpg}};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Draw connections
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\draw [connection]  (b1-east)    -- node {\midarrow} (b2-west);
\draw [connection]  (p2-east)    -- node {\midarrow} (cr3-west);
\draw [connection]  (p3-east)    -- node {\midarrow} (cr4-west);
\draw [connection]  (p4-east)    -- node {\midarrow} (cr5-west);
\draw [connection]  (p5-east)    -- node {\midarrow} (cr6-west);
\draw [connection]  (cr6-east)   -- node {\midarrow} (mu-west);
\draw [connection]  (cr6-east)   -- node {\midarrow} (sig-west);
\draw [connection]  (mu-east)   -- node {\midarrow} (sample-west);
\draw [connection]  (sig-east)   -- node {\midarrow} (sample-west);
\draw [connection]  (eps-north)   -- node {\midarrow} (sample-south);
\draw [connection]  (sample-east)   -- node {\midarrow} (z-west);
\draw [connection]  (z-east)   -- node {\midarrow} (z1-west);
\draw [connection]  (z-east)   -- node {\midarrow} (z2-west);
\draw [connection]  (z-east)   -- node {\midarrow} (z3-west);

\draw [connection]  (z-east)   -- node {\midarrow} ([yshift=-120pt,xshift=-10pt]z1-west);

\draw [connection]  (z1-east)   -- node {\midarrow} (u11-west);
\draw [connection]  (u11-east)   -- node {\midarrow} (s11-west);
\draw [connection]  (u21-east)   -- node {\midarrow} (s21-west);
\draw [connection]  (u31-east)   -- node {\midarrow} (s31-west);


\draw [connection]  (z3-east)   -- node {\midarrow} (u12-west);
\draw [connection]  (u12-east)   -- node {\midarrow} (s12-west);
\draw [connection]  (u22-east)   -- node {\midarrow} (s22-west);
\draw [connection]  (u32-east)   -- node {\midarrow} (s32-west);

\draw [connection]  (z2-east)   -- node {\midarrow} (u13-west);
\draw [connection]  (u13-east)   -- node {\midarrow} (s13-west);
\draw [connection]  (u23-east)   -- node {\midarrow} (s23-west);
\draw [connection]  (u33-east)   -- node {\midarrow} (s33-west);


\draw [connection]  (u43-east)   -- node {\midarrow} ([yshift=-10pt,xshift=10pt]concat.west);
\draw [connection]  (u41-east)   -- node {\midarrow} ([yshift=10pt,xshift=10pt]concat.west);

\draw [connection]  (concat.east)   -- node {\midarrow} (soft-west);


% Legend
\matrix [draw,above,shift={(0,3,0)}] at (b2-north) {
  \node [draw, fill=\ConvReluColor,minimum width=1cm,minimum height=1cm, 
        opacity=1,label=right:\huge{\bf activation}] {}; &
  \node [draw, fill=\ConvColor,minimum width=1cm,minimum height=1cm,
        opacity=0.5,label=right:\huge{\bf convolution}] {}; \\
  \node [draw, fill=\PoolColor,minimum width=1cm,minimum height=1cm,
        opacity=.5,label=right:\huge{\bf max pooling}] {}; &
  \node [draw, fill=\SoftmaxColor,minimum width=1cm,minimum height=1cm,
        opacity=0.5,label=right:\huge{\bf softmax}] {}; \\
  \node [draw, fill=\SliceColor,minimum width=1cm,minimum height=1cm,
        opacity=0.5,label=right:\huge{\bf slice}] {}; &
  \node [draw, fill=\SubpixColor,minimum width=1cm,minimum height=1cm,
        opacity=0.5,label=right:\huge{\bf subpixel convolution}] {}; \\
  \node [minimum width=1cm,minimum height=1cm,
        label=right:\huge{\bf concatenation}] {\scalebox{4}{$\otimes$}}; &
  \node [minimum width=1cm,minimum height=1cm,
        label=right:\huge{\bf resample}] {\scalebox{2}{\bf */+}}; \\
};

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\end{tikzpicture}
\end{document}\grid
